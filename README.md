# azure-monitor



### [Azure Monitor data platform](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-platform)

Azure Monitor는 metric 수집을 위한 [Metrics 저장소(store)](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-platform-metrics)와 Log 수집을 위한 [Log 저장소(store)](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/data-platform-logs)를 제공합니다. 

Metric 저장소는 시계열 데이타를 time-series database인 metric 저장소에 저장합니다. 

Log 저장소인 Log Analytics는 timestamp를 가지고 있는 로그 entry들을 저장하고 또한 빠른 분석을 위한 query 기능을 제공합니다. 

추가로 Application단의 metric 및 로그를 저장 분석을 위한 Application Insights는 Application단의 metric 및 로그를 수집하고 다양한 분석 기능 및 query 기능을 제공합니다. 



### [Azure Diagnostics extension overview](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostics-extension-overview)

Azure Diagnostics extension은 Virtual Machine의 Guest  OS단의 custom metric에 대한 수집 기능을 제공합니다. 

Azure Diagnostics extension이 수집하는 데이타는 아래와 같습니다. 

#### [Windows diagnostics extension (WAD)](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostics-extension-overview#windows-diagnostics-extension-wad)

| Data Source                                                  | Description                                                  |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| Windows Event logs                                           | Events from Windows event log.                               |
| Performance counters                                         | Numerical values measuring performance of different aspects of operating system and workloads. |
| IIS Logs                                                     | Usage information for IIS web sites running on the guest operating system. |
| Application logs                                             | Trace messages written by your application.                  |
| .NET EventSource logs                                        | Code writing events using the .NET [EventSource](https://msdn.microsoft.com/library/system.diagnostics.tracing.eventsource.aspx) class |
| [Manifest based ETW logs](https://docs.microsoft.com/windows/desktop/etw/about-event-tracing) | Event Tracing for Windows events generated by any process.   |
| Crash dumps (logs)                                           | Information about the state of the process if an application crashes. |
| File based logs                                              | Logs created by your application or service.                 |
| Agent diagnostic logs                                        | Information about Azure Diagnostics itself.                  |

#### [Linux diagnostics extension (LAD)](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostics-extension-overview#linux-diagnostics-extension-lad)

| Data Source          | Description                                                  |
| :------------------- | :----------------------------------------------------------- |
| Syslog               | Events sent to the Linux event logging system.               |
| Performance counters | Numerical values measuring performance of different aspects of operating system and workloads. |
| Log files            | Entries sent to a file based log.                            |



Azure Diagnostics extension은 아래의 기능을 제공합니다. 

- metric/log 데이타를 Azure blob Storage로 전송
- custom metric 데이타를 [Azure Monitor metric store로 전송 (Windows VM only)](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/collect-custom-metrics-guestos-resource-manager-vm). Linux VM의 경우 [Telegraf agent 설치 필요](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/collect-custom-metrics-linux-telegraf)
- metric/log 데이타를 [Event Hub로 전송](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostics-extension-stream-event-hubs)
- metric/log 데이타를 [Application Insights로 전송](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/diagnostics-extension-to-application-insights)





### Azure Monitor Data Sink

New "AzureMonitor" sink is added from Diagnostics Extension version 1.11. This "AzureMonitor" sink sends Guest OS performance metrics to Azure Monitor metric store.

"Azure Monitor" sink can be enabled at "Diagnostic settings" of Virtual Machine menu on Azure Portal. As of April 2020, this feature is preview but can be enabled on every Azure region with Azure Template. 

To enable "Azure Monitor" sink, a Managed Identity shall be assigned to the VM first so that the VM can access Azure Monitor metrics store. 

![image-20200331221003987](C:\Users\hyuk\AppData\Roaming\Typora\typora-user-images\image-20200331221003987.png)

![](C:\Users\hyuk\AppData\Roaming\Typora\typora-user-images\image-20200331220504385.png)



### Installing Diagnostics Extension using Terraform

























